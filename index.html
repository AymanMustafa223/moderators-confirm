<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>نظام تأكيد الأوردرات</title>
<style>
body{font-family:Arial;padding:20px;direction:rtl;max-width:700px;margin:auto}
input,button,select{width:100%;padding:8px;margin:6px 0}
button{cursor:pointer}
.product-block{border:1px solid #ccc;padding:10px;margin-top:10px;border-radius:5px}
</style>
</head>
<body>

<h2>تسجيل دخول المودريتور</h2>
<div id="loginDiv">
  <input type="text" id="username" placeholder="اسم المستخدم">
  <input type="password" id="password" placeholder="كلمة المرور">
  <button onclick="login()">تسجيل دخول</button>
  <p id="loginMsg" style="color:red"></p>
</div>

<div id="orderDiv" style="display:none;">
  <h2>إضافة أوردرات</h2>
  
  <input type="text" id="clientName" placeholder="اسم العميل">
  <input type="text" id="clientPhone" placeholder="رقم الموبايل">
  
  <div id="productsContainer"></div>
  
  <button onclick="addProduct()">إضافة منتج</button>
  <button onclick="submitOrder()">حفظ الأوردر</button>
</div>

<script>
// قائمة المودريتورز
const moderators = [
  {username:'admin', password:'1234'},
  {username:'mod1', password:'5678'}
];

// تسجيل دخول
function login(){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  const mod = moderators.find(m => m.username===username && m.password===password);
  if(mod){
    alert('تم تسجيل الدخول بنجاح!');
    document.getElementById('loginDiv').style.display='none';
    document.getElementById('orderDiv').style.display='block';
    addProduct(); // إضافة أول منتج تلقائيًا
    window.currentModerator = username; // حفظ اسم المودريتور
  } else {
    alert('خطأ في اسم المستخدم أو كلمة المرور');
  }
}

// إضافة منتج جديد
function addProduct(){
  const container = document.getElementById('productsContainer');
  const div = document.createElement('div');
  div.className = 'product-block';
  div.innerHTML = `
    <h4>منتج جديد</h4>
    <input type="text" placeholder="كود المنتج" class="productCode">
    <input type="text" placeholder="اللون" class="color">
    <input type="text" placeholder="المقاس" class="size">
    <input type="number" placeholder="السعر" class="price">
  `;
  container.appendChild(div);
}

// حفظ الأوردر وإرسال البيانات للـ Google Sheet
function submitOrder(){
  const clientName = document.getElementById('clientName').value.trim();
  const clientPhone = document.getElementById('clientPhone').value.trim();
  
  if(!clientName || !clientPhone){
    alert('يرجى إدخال اسم العميل ورقم الموبايل.');
    return;
  }

  const prodsDivs = document.querySelectorAll('.product-block');
  if(prodsDivs.length === 0){
    alert('يرجى إضافة منتج واحد على الأقل.');
    return;
  }

  const products = Array.from(prodsDivs).map(div => ({
    productCode: div.querySelector('.productCode').value.trim() || '',
    color: div.querySelector('.color').value.trim() || '',
    size: div.querySelector('.size').value.trim() || '',
    price: div.querySelector('.price').value.trim() || '0'
  }));

  const payload = {
    moderator: window.currentModerator,
    clientName: clientName,
    clientPhone: clientPhone,
    products: products
  };

  // تحقق من صحة JSON قبل الإرسال
  console.log('Payload:', JSON.stringify(payload));

  fetch('https://script.google.com/macros/s/AKfycbzQqfeks-PrIdyY4_wp8dLFgHq-tHsCZPSUMhSSzxuVj2sEcKiNJr3ZdaWKp9hLMsE/exec', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if(data.status==='ok'){
      alert('تم حفظ الأوردر بنجاح!');
      // تنظيف الفورم بعد الحفظ
      document.getElementById('clientName').value='';
      document.getElementById('clientPhone').value='';
      document.getElementById('productsContainer').innerHTML='';
      addProduct(); // إضافة منتج فارغ جديد
    } else {
      alert('حدث خطأ: '+data.error);
    }
  })
  .catch(err => alert('حدث خطأ: '+err.message));
}
</script>

</body>
</html>
